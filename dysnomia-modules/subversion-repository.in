#!/bin/bash -e

# Autoconf settings
export prefix=@prefix@

# Import utility functions
source @datadir@/@PACKAGE@/util

determineComponentName $2
checkStateDir
determineTypeIdentifier $0
composeSnapshotsPath
composeGarbagePath
composeGenerationsPath

case "$1" in
    # Creates a Subversion repository and imports a Subversion dump if provided
    activate)
        if [ ! -e $svnBaseDir/$componentName ]
        then
            mkdir -p $svnBaseDir
            
            @svnadmin@ create $svnBaseDir/$componentName
            if [ -d $2/subversion-repositories ]
            then
                cat $2/subversion-repositories/* | @svnadmin@ load $svnBaseDir/$componentName
            fi
            
            chgrp -R $svnGroup $svnBaseDir/$componentName
            chmod -R g+w $svnBaseDir/$componentName
            chmod g+s $svnBaseDir/$componentName/db
        fi
        unmarkStateAsGarbage
        ;;
    deactivate)
        markStateAsGarbage
        ;;
    snapshot)
        rev=$(cat $svnBaseDir/$componentName/db/current)
        
        if [ ! -d $snapshotsPath/$rev ]
        then
            mkdir -p $snapshotsPath/$rev
            @svnadmin@ dump -r $rev $svnBaseDir/$componentName | xz > $snapshotsPath/$rev/dump.xz
            createGenerationSymlink $snapshotsPath/$rev
        fi
        ;;
    restore)
        rev=$(cat $svnBaseDir/$componentName/db/current)
        determineLastSnapshot
        
        if [ "$lastSnapshot" != "" ] && [ "$rev" != "$lastSnapshot" ]
        then
            rm -Rf $svnBaseDir/$componentName
            @svnadmin@ create $svnBaseDir/$componentName
            chgrp -R $svnGroup $svnBaseDir/$componentName
            chmod -R g+w $svnBaseDir/$componentName
            chmod g+s $svnBaseDir/$componentName/db
            xzcat $snapshotsPath/$lastSnapshot/dump.xz | @svnadmin@ load $svnBaseDir/$componentName
        fi
        ;;
    collect-garbage)
        if [ -f $garbagePath ]
        then
            rm -Rf $svnBaseDir/$componentName
            unmarkStateAsGarbage
        fi
        ;;
esac
