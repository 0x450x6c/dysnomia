#!/bin/bash
set -e
set -o pipefail

# Activates or deactivates the web applications in the webapps/ subfolder by
# symlinking them into the document root folder of the Apache HTTP server.
#
# Container properties (environment variables):
# documentRoot: Path to the document root folder (defaults to: /var/www)

# Autoconf settings
export prefix=@prefix@

# Import utility functions
source @datadir@/@PACKAGE@/util

# Sets a number of common utility environment variables
composeUtilityVariables $0 $2 $3

if [ "$documentRoot" = "" ]
then
    documentRoot=/var/www
fi

case "$1" in
    activate)
        mkdir -p "$documentRoot"

        if [ -f "$2/.dysnomia-fileset" ]
        then
            export targetDir="$documentRoot"
            @libexecdir@/fileset activate "$2" apache-webapplication
        else
            ls $(readlink -f $2/webapps) | while read i
            do
                ln -sfn $2/webapps/$i $documentRoot
                markComponentAsActive
            done
        fi
        ;;
    deactivate)
        if [ -f "$2/.dysnomia-fileset" ]
        then
            export targetDir="$documentRoot"
            @libexecdir@/fileset deactivate "$2" apache-webapplication
        else
            ls $(readlink -f $2/webapps) | while read i
            do
                rm -f $documentRoot/$(basename $i)
                unmarkComponentAsActive
            done
        fi
        ;;

    snapshot|restore|collect-garbage)
        if [ -f "$2/.dysnomia-fileset" ]
        then
            export targetDir="$documentRoot"
            @libexecdir@/fileset "$1" "$2" apache-webapplication
        fi
        ;;
esac
