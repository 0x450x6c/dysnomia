#!/bin/bash -e

ejabberdctl='@ejabberdctl@ --config-dir /var/ejabberd --logs /var/log/ejabberd --spool /var/lib/ejabberd'

case "$1" in
    activate)
        # Wait until the ejabberd daemon is available
        count=0
        while ! $ejabberdctl status
        do
            if [ $count -eq 30 ]
            then
                echo "Tried 30 times, giving up..."
                exit 1
            fi
            
            echo "Ejabberd daemon not yet started. Waiting for 1 second..."
            count=$((count++))
            sleep 1
        done
        
        # Load the dump
        if [ -f $2 ]
        then
            $ejabberdctl load $2
        elif [ -d $2 ]
        then
            $ejabberdctl load $2/ejabberd-dump/*
        fi
        ;;
    deactivate)
        # An ejabberd dump cannot be deactivated, we do not want to drop user accounts
        # with all data in it, right?
        echo
        ;;
esac
