#!/bin/bash -e

# Autoconf settings
export prefix=@prefix@

# Import utility functions
source @datadir@/@PACKAGE@/util

determineComponentName $2
checkStateDir
determineTypeIdentifier $0
composeSnapshotsPath
composeGarbagePath

case "$1" in
    activate)
        # Initalize the given schema if the database does not exists
        if [ "$(echo "show databases" | @mysql@ --user=$mysqlUsername --password=$mysqlPassword -N | grep -x $componentName)" = "" ]
        then
            ( echo "create database $componentName;"
              echo "use $componentName;"
              
              if [ -d $2/mysql-databases ]
              then
                  cat $2/mysql-databases/*.sql
              fi
            ) | @mysql@ --user=$mysqlUsername --password=$mysqlPassword -N
        fi
        unmarkStateAsGarbage
        ;;
    deactivate)
        markStateAsGarbage
        ;;
    snapshot)
        now=$(date +%s)
        mkdir -p $snapshotsPath/$now
        @mysqldump@ --single-transaction --quick --user=$mysqlUsername --password=$mysqlPassword $componentName | xz > $snapshotsPath/$now/dump.sql.xz
        ;;
    restore)
        determineLastSnapshot
        
        ( echo "use $componentName;"
          xzcat $snapshotsPath/$lastSnapshot/dump.sql.xz
        ) | @mysql@ --user=$mysqlUsername --password=$mysqlPassword -N
        ;;
    collect-garbage)
        if [ -f $garbagePath ]
        then
            echo "drop database $componentName;" | @mysql@ --user=$mysqlUsername --password=$mysqlPassword -N
            unmarkStateAsGarbage
        fi
        ;;
esac
